{% extends 'gestion_activos/base.html' %}
{% load static %}

{% block title %}Lista de Activos{% endblock %}

{% block content %}
<h2 class="mb-4">Lista de Activos</h2>

<!-- Filtros y acciones -->
<div class="card bg-dark text-white p-3 mb-3">
  <div class="d-flex flex-wrap align-items-center gap-2">

    <!-- Filtros -->
    <select id="estado_filtro" class="form-select form-select-sm bg-light text-dark" style="width: 150px;">
      <option value="">üìÅ Estado</option>
      <option value="activo">Activo</option>
      <option value="inactivo">Inactivo</option>
      <option value="en_mantenimiento">Mantenimiento</option>
    </select>

    <select id="categoria_filtro" class="form-select form-select-sm bg-light text-dark" style="width: 180px;">
      <option value="">üìÇ Categor√≠a</option>
      {% for cat in categorias %}
        <option value="{{ cat.id }}">{{ cat.nombre }}</option>
      {% endfor %}
    </select>

    <select id="ubicacion_filtro" class="form-select form-select-sm bg-light text-dark" style="width: 180px;">
      <option value="">üìç Ubicaci√≥n</option>
      {% for ub in ubicaciones %}
        <option value="{{ ub.id }}">{{ ub.nombre }}</option>
      {% endfor %}
    </select>

    <button id="btn-filtrar" class="btn btn-primary btn-sm">
      <i class="fas fa-filter"></i>
    </button>

    <!-- Acciones -->
    <a href="{% url 'registrar_activo' %}" class="btn btn-success btn-sm ms-auto">
      <i class="fas fa-plus"></i>
    </a>
    <a id="export-pdf" class="btn btn-danger btn-sm" href="#">
      <i class="fas fa-file-pdf"></i>
    </a>
    <a id="export-xls" class="btn btn-info btn-sm text-white" href="#">
      <i class="fas fa-file-excel"></i>
    </a>
  </div>
</div>

<!-- Tabla -->
<table id="tabla-activos" class="table table-bordered table-hover table-dark">
  <thead>
    <tr>
      <th>C√≥digo</th>
      <th>Nombre</th>
      <th>Descripci√≥n</th>
      <th>Categor√≠a</th>
      <th>Ubicaci√≥n</th>
      <th>Estado</th>
      <th>Acciones</th>
    </tr>
  </thead>
</table>
{% endblock %}

{% block extra_js %}
<script>
 $(document).ready(function () {
    const tabla = $('#tabla-activos').DataTable({
      ajax: {
        url: "{% url 'api_activos_filtrados' %}",
        data: function (d) {
          d.estado = $('#estado_filtro').val();
          d.categoria = $('#categoria_filtro').val();
          d.ubicacion = $('#ubicacion_filtro').val();
        }
      },
      columns: [
        { data: 'codigo' },
        { data: 'nombre' },
        { data: 'descripcion' },
        { data: 'categoria' },
        { data: 'ubicacion' },
        {
          data: 'estado',
          render: function (data) {
            let clase = 'secondary';
            if (data.includes('activo')) clase = 'success';
            else if (data.includes('inactivo')) clase = 'danger';
            else if (data.includes('mantenimiento')) clase = 'warning';
            return `<span class="badge bg-${clase}">${data}</span>`;
          }
        },
        {
          data: 'id',
          render: function (id) {
            return `
              <a href="/activos/editar/${id}/" class="btn btn-warning btn-sm">‚úèÔ∏è</a>
              <a href="/activos/eliminar/${id}/" class="btn btn-danger btn-sm">üóëÔ∏è</a>
            `;
          }
        }
      ],
      language: {
        url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      }
    });

    $('#btn-filtrar').on('click', function () {
      tabla.ajax.reload();
    });

    // Exportar con filtros
    function buildQueryParams() {
      const estado = $('#estado_filtro').val();
      const categoria = $('#categoria_filtro').val();
      const ubicacion = $('#ubicacion_filtro').val();
      let query = '?';
      if (estado) query += `estado=${estado}&`;
      if (categoria) query += `categoria=${categoria}&`;
      if (ubicacion) query += `ubicacion=${ubicacion}&`;
      return query;
    }

    $('#export-pdf').on('click', function (e) {
      e.preventDefault();
      window.location.href = "{% url 'reporte_pdf' %}" + buildQueryParams();
    });

    $('#export-xls').on('click', function (e) {
      e.preventDefault();
      window.location.href = "{% url 'exportar_excel' %}" + buildQueryParams();
    });
  });
</script>
{% endblock %}