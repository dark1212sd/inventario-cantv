{% extends 'gestion_activos/base.html' %}
{% load static %}

{% block title %}Lista de Activos{% endblock %}

{% block content %}
<h2 class="mb-4">Lista de Activos</h2>

<div class="card bg-dark text-white p-3 mb-3">
  <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
    <input type="text" id="busqueda" placeholder="üîç Buscar nombre o descripci√≥n" class="form-control form-control-sm bg-light text-dark" style="width: 250px;">

    <select id="estado_filtro" class="form-select form-select-sm bg-light text-dark" style="width: 150px;">
      <option value="">üìÅ Estado</option>
      <option value="activo">Activo</option>
      <option value="inactivo">Inactivo</option>
      <option value="en_mantenimiento">Mantenimiento</option>
    </select>

    <select id="categoria_filtro" class="form-select form-select-sm bg-light text-dark" style="width: 180px;">
      <option value="">üìÇ Categor√≠a</option>
      {% for cat in categorias %}
        <option value="{{ cat.id }}">{{ cat.nombre }}</option>
      {% endfor %}
    </select>

    <select id="ubicacion_filtro" class="form-select form-select-sm bg-light text-dark" style="width: 180px;">
      <option value="">üìç Ubicaci√≥n</option>
      {% for ub in ubicaciones %}
        <option value="{{ ub.id }}">{{ ub.nombre }}</option>
      {% endfor %}
    </select>

    <button id="btn-filtrar" class="btn btn-primary btn-sm">
      <i class="fas fa-filter"></i> Filtrar
    </button>

    <a href="{% url 'registrar_activo' %}" class="btn btn-success btn-sm ms-auto">
      <i class="fas fa-plus"></i>
    </a>
    <button id="exportarPdf" class="btn btn-danger btn-sm">
      <i class="fas fa-file-pdf"></i>
    </button>
    <button id="exportarExcel" class="btn btn-info btn-sm text-white">
      <i class="fas fa-file-excel"></i>
    </button>
  </div>
</div>

<table id="tabla-activos" class="table table-striped table-bordered w-100">
  <thead class="table-dark">
    <tr>
      <th>C√≥digo</th>
      <th>Nombre</th>
      <th>Descripci√≥n</th>
      <th>Categor√≠a</th>
      <th>Ubicaci√≥n</th>
      <th>Estado</th>
      <th>Acciones</th>
    </tr>
  </thead>
</table>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {
  const tabla = $('#tabla-activos').DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: "{% url 'api_activos_filtrados' %}",
      dataSrc: 'data',
      data: function (d) {
        d.estado = $('#estado_filtro').val();
        d.categoria = $('#categoria_filtro').val();
        d.ubicacion = $('#ubicacion_filtro').val();
        d.search = $('#busqueda').val();
      }
    },
    columns: [
      { data: 'codigo' },
      { data: 'nombre' },
      { data: 'descripcion' },
      { data: 'categoria' },
      { data: 'ubicacion' },
      {
        data: 'estado',
        render: function (data) {
          let badgeClass = 'secondary';
          if (data.toLowerCase() === 'activo') badgeClass = 'success';
          else if (data.toLowerCase() === 'inactivo') badgeClass = 'danger';
          else if (data.toLowerCase().includes('mantenimiento')) badgeClass = 'warning';
          return `<span class="badge bg-${badgeClass}">${data}</span>`;
        }
      },
      {
        data: 'id',
        render: function (id) {
          return `
            <a href="/activos/editar/${id}/" class="btn btn-warning btn-sm">‚úèÔ∏è</a>
            <a href="/activos/eliminar/${id}/" class="btn btn-danger btn-sm">üóëÔ∏è</a>
          `;
        },
        orderable: false,
        searchable: false
      }
    ],
    language: {
      url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
    }
  });

  $('#btn-filtrar, #estado_filtro, #categoria_filtro, #ubicacion_filtro').on('change click', function () {
    tabla.ajax.reload();
  });

  $('#busqueda').on('keyup', function () {
    tabla.ajax.reload();
  });

  $('#exportarPdf').click(function () {
    const estado = $('#estado_filtro').val();
    const categoria = $('#categoria_filtro').val();
    const ubicacion = $('#ubicacion_filtro').val();
    const params = new URLSearchParams({ estado, categoria, ubicacion });
    window.location.href = `{% url 'reporte_pdf' %}?${params}`;
  });

  $('#exportarExcel').click(function () {
    const estado = $('#estado_filtro').val();
    const categoria = $('#categoria_filtro').val();
    const ubicacion = $('#ubicacion_filtro').val();
    const params = new URLSearchParams({ estado, categoria, ubicacion });
    window.location.href = `{% url 'exportar_excel' %}?${params}`;
  });
});
</script>
{% endblock %}