{% extends 'gestion_activos/base.html' %}
{% load static %}

{% block title %}Lista de Activos{% endblock %}

{% block content %}
<h2 class="mb-4">Lista de Activos</h2>

<!-- Filtros y acciones -->
<div class="card bg-dark text-white p-3 mb-3">
  <form method="get" class="d-flex flex-wrap align-items-center gap-2 mb-2">

    <!-- Buscar -->
    <input
      type="text"
      id="buscar_filtro"
      class="form-control form-control-sm bg-light text-dark"
      placeholder="🔍 Buscar nombre o descripción"
      style="width: 300px;"
    >

    <!-- Estado -->
    <select
      name="estado"
      id="estado_filtro"
      class="form-select form-select-sm bg-light text-dark"
      style="width: 150px;"
    >
      <option value="">📁 Estado</option>
      <option value="activo">Activo</option>
      <option value="inactivo">Inactivo</option>
      <option value="en_mantenimiento">Mantenimiento</option>
    </select>

    <!-- Categoría -->
    <select
      name="categoria"
      id="categoria_filtro"
      class="form-select form-select-sm bg-light text-dark"
      style="width: 180px;"
    >
      <option value="">📂 Categoría</option>
      {% for cat in categorias %}
        <option value="{{ cat.id }}">{{ cat.nombre }}</option>
      {% endfor %}
    </select>

    <!-- Ubicación -->
    <select
      name="ubicacion"
      id="ubicacion_filtro"
      class="form-select form-select-sm bg-light text-dark"
      style="width: 180px;"
    >
      <option value="">📍 Ubicación</option>
      {% for ub in ubicaciones %}
        <option value="{{ ub.id }}">{{ ub.nombre }}</option>
      {% endfor %}
    </select>

    <!-- Botón Filtrar -->
    <button type="button" id="btn-filtrar" class="btn btn-primary btn-sm">
      <i class="fas fa-filter"></i> Filtrar
    </button>

    <!-- Botón Nuevo -->
    <a href="{% url 'registrar_activo' %}" class="btn btn-success btn-sm">
      <i class="fas fa-plus"></i>
    </a>

    <!-- Exportar PDF -->
    <a id="export-pdf" class="btn btn-danger btn-sm" href="{% url 'reporte_pdf' %}?estado=&categoria=&ubicacion=">
      <i class="fas fa-file-pdf"></i>
    </a>

    <!-- Exportar Excel -->
    <a id="export-xls" class="btn btn-info btn-sm text-white" href="{% url 'exportar_excel' %}?estado=&categoria=&ubicacion=">
      <i class="fas fa-file-excel"></i>
    </a>

  </form>
</div>

<!-- Tabla -->
<table id="tabla-activos" class="table table-bordered table-hover table-dark">
  <thead>
    <tr>
      <th>Código</th>
      <th>Nombre</th>
      <th>Descripción</th>
      <th>Categoría</th>
      <th>Ubicación</th>
      <th>Estado</th>
      <th>Acciones</th>
    </tr>
  </thead>
</table>
{% endblock %}

{% block extra_js %}
<script>
 $(document).ready(function () {
  const tabla = $('#tabla-activos').DataTable({
    processing: true,
    serverSide: false,
    ajax: {
      url: '{% url "api_activos_filtrados" %}',
      dataSrc: 'data',
      data: function (d) {
        d.estado = $('#estado_filtro').val();
        d.categoria = $('#categoria_filtro').val();
        d.ubicacion = $('#ubicacion_filtro').val();
        d.search = $('#buscar_filtro').val();
      },
      error: function (xhr, status, error) {
        console.error('Error al cargar datos:', error);
        console.log(xhr.responseText);
      }
    },
    columns: [
      { data: 'codigo' },
      { data: 'nombre' },
      { data: 'descripcion' },
      { data: 'categoria' },
      { data: 'ubicacion' },
      { data: 'estado' }
    ],
    language: {
      url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
    }
  });

  // Botón para filtrar
  $('#btn-filtrar').on('click', function () {
    tabla.ajax.reload();
  });
});
</script>
{% endblock %}